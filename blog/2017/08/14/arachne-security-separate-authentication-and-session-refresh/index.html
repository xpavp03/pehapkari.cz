<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="description" content="Oficiální stránky PHP komunity">
    <meta name="keywords" content="PHP, komunita, programování">
    <meta name="author" content="https://pehapkari.cz">
    <meta name="robots" content="index, follow">

    <meta property="og:image" content="/images/php-square.png">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

    <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <link href="/assets/bootstrap/bootstrap.min.css?v=0.6" rel="stylesheet" type="text/css">

    <link href="/assets/css/style.css?v=0.6" rel="stylesheet" type="text/css">

    <link href="/favicon.ico" rel="shortcut icon">

    <title>Arachne/Security - Separate Authentication and Session Refresh</title>
</head>

    <body>
<header>
    <div class="hidden-sm-down">
        <div class="container-fluid">
            <a href="/"><img src="/assets/images/logo-header.svg?ver" alt="" height="50"></a>

            <nav class="navbar top-navigation">
                <a href="/blog/" class="active">
                    <em class="fa fa-newspaper-o fa-fw"></em>
                    Blog
                </a>
                <a href="/vzdelavej-se/">
                    <em class="fa fa-graduation-cap fa-fw"></em>
                    Školení
                </a>
                <a href="/mentori/">
                    <em class="fa fa-handshake-o fa-fw"></em>
                    Mentoři
                </a>

                    

                    <a href="https://github.com/pehapkari/pehapkari.cz/edit/master/source/_posts/2017/2017-08-14-arachne-security-separate-authentication-and-session-refresh.md" class="hidden-sm">
                        <em class="fa fa-fw fa-pencil"></em>
                        Edit
                    </a>
            </nav>
        </div>
    </div>

    <div id="mobile-menu" class="row text-center hidden-md-up">
        <div class="container">
            <a href="/" class="col-3 col-sm-3">
                <em class="fa fa-home"></em>
                <br>
                Home
            </a>
            <a href="/blog/" class="col-3 col-sm-3 active">
                <em class="fa fa-book fa-fw"></em>
                <br>
                Blog
            </a>
            <a href="/vzdelavej-se/" class="col-3 col-sm-3">
                <em class="fa fa-graduation-cap fa-fw"></em>
                <br>
                Školení
            </a>
            <a href="/mentori/" class="col-3 col-sm-3">
                <em class="fa fa-handshake-o fa-fw"></em>
                <br>
                Mentoři
            </a>
        </div>
    </div>
</header>

        <div id="article">
            <div class="container">
                <h1 class="h2 text-center">Arachne/Security - Separate Authentication and Session Refresh</h1>

                <div class="row text-center">
                    <div class="col-md-12">
<div class="metadataLine">

    <p>
        <em class="fa fa-clock-o fa-fw"></em>
        4 min

        |

        by <strong>Jáchym Toušek</strong>

        &ndash;

        <time datetime="2017-08-Mon">
            14. 8. 2017
        </time>

    </p>
</div>
                        <div id="reviewed_by">
                            <p>Peer-Reviewed by:
                                    Tomáš Votruba, 
                                    David Matějka, 
                                    Milan Felix Šulc
                            </p>
                        </div>
                    </div>
                </div>

                <br>

                <div id="article-content">
                    <p class="perex">In many cases <a href="https://github.com/nette/security">Nette/Security</a> lacks the API needed for certain tasks.
Experienced Nette users therefore often recommend using some custom solution instead.
In this article I'll go over the known problems with user authentication and how <a href="https://github.com/Arachne/Security">Arachne/Security</a> can help you solve them.</p>

                    
<h2 id="separate-authentication"><a class="anchor" href="#separate-authentication" aria-hidden="true"><span class="anchor-icon">#</span></a>Separate Authentication</h2>
<p>For e-shops and many other applications you may need <strong>completely separated accounts for administrators and for custommers</strong>. While it could be solved with authorization instead, separate authentication is often preferred.</p>
<p>Nette/Security does not have a good support for this. Quite often programmers don't use the <code>Nette\Security\User</code> at all and instead work directly with <code>Nette\Http\UserStorage</code>. With Arachne/Security you will use <code>Arachne\Security\Authentication\Firewall</code> instead of <code>Nette\Security\User</code> - however unlike <code>Nette\Security\User</code> it is common to use multiple separate firewalls.</p>
<p>A firewall is basically a shield that protects a part of your application. It is an equivalent of <code>Nette\Security\User</code> with slightly different API:</p>
<ul>
<li><code>Firewall::login(IIdentity $identity)</code> - unlike <code>User::login()</code> you should check the user credentials beforehand and only call this method if the user authenticated successfully.</li>
<li><code>Firewall::logout()</code> - same as <code>User::logout()</code>.</li>
<li><code>Firewall::getIdentity()</code> - use instead of <code>User::isLoggedIn()</code> and <code>User::getIdentity()</code>. Unlike <code>User::getIdentity()</code> it will only return a non-expired <code>IIdentity</code>.</li>
</ul>
<pre><code class="language-yaml">arachne.security:
    arachne.serviceCollections: Arachne\ServiceCollections\DI\ServiceCollectionsExtension
    arachne.security: Arachne\Security\DI\SecurityExtension

arachne.security:
    firewalls:
        - admin
        - front</code></pre>
<p>The above configuration will create two separate <code>Arachne\Security\Authentication\Firewall</code> services. For autowiring you might want to improve it with your own classes.</p>
<pre><code class="language-yaml">arachne.security:
    firewalls:
        admin: App\Module\AdminModule\Security\AdminFirewall
        front: App\Module\FrontModule\Security\FrontFirewall</code></pre>
<pre><code class="language-php">namespace App\Module\AdminModule\Security;

use Arachne\Security\Authentication\Firewall;

class AdminFirewall extends Firewall
{
    // This class is just for autowiring. You don't need to implement any methods here.
}</code></pre>
<pre><code class="language-php">namespace App\Module\FrontModule\Security;

use Arachne\Security\Authentication\Firewall;

class FrontFirewall extends Firewall
{
    // This class is just for autowiring. You don't need to implement any methods here.
}</code></pre>
<h2 id="session-refresh"><a class="anchor" href="#session-refresh" aria-hidden="true"><span class="anchor-icon">#</span></a>Session Refresh</h2>
<p>In Nette/Security when a user signs in his identity is by default serialized and stored in session and is valid until he signs out again or is signed out automatically because of expiration. The problem is that if you change the privileges of a user or remove his account his session will not be updated with the new privileges or terminated right away. The user will still have the same roles he had when he signed in. Also in case an attacker steals the user's password or cookie the attacker can still use his active session even after the user's password is changed.</p>
<p>In Nette this is considered a feature because to solve it you would have to check the database whether the session is still valid each time he sends a request. I consider this a security issue so I added an optional mechanism to Arachne/Security to deal with this and refresh the session or force-logout the user.</p>
<p>You can enable this mechanism by implementing <code>Arachne\Security\Authentication\IdentityValidatorInterface</code>. <strong>Your implementation gets the user's identity and should return an updated identity or null to force logout.</strong></p>
<p>Here is an example how to register and implement it. It is based on Doctrine and simply creates new <code>Identity</code> every time or forces logout if the user was deleted.</p>
<pre><code class="language-yaml">services:
    admin.identityValidator:
        class: App\Module\AdminModule\Security\AdminIdentityValidator
        tags:
            arachne.security.identityValidator: admin</code></pre>
<pre><code class="language-php">namespace App\Module\AdminModule\Security;

use App\Module\AdminModule\Entity\Role;
use App\Module\AdminModule\Entity\User;
use Arachne\Security\Authentication\IdentityValidatorInterface;
use Doctrine\ORM\EntityManager;
use Doctrine\ORM\EntityRepository;
use Nette\Security\Identity;
use Nette\Security\IIdentity;

class AdminIdentityValidator implements IdentityValidatorInterface
{
    /**
     * @var EntityManager
     */
    private $entityManager;

    public function __construct(EntityManager $entityManager)
    {
        $this-&gt;entityManager = $entityManager;
    }

    public function validateIdentity(IIdentity $identity): ?IIdentity
    {
        $entity = $this-&gt;entityManager-&gt;getRepository(User::class)-&gt;find($identity-&gt;getId());

        if (! $entity) {
             return null;
        }

        $roles = array_map(
            function (Role $role) {
                return $role-&gt;getName();
            },
            $entity-&gt;getRoles()
        );

        return new Identity(
            $entity-&gt;getId(),
            $roles,
            [
                'name' =&gt; $entity-&gt;getName(),
                'email' =&gt; $entity-&gt;getEmail(),
            ]
        );
    }
}</code></pre>
<h2 id="conclusion"><a class="anchor" href="#conclusion" aria-hidden="true"><span class="anchor-icon">#</span></a>Conclusion</h2>
<p>The goal of Arachne/Security is only to provide a better API then Nette/Security. It just implements what Nette could not because of BC but still internally uses some of the classes and interfaces from Nette/Security.</p>
<p>This article was about authentication improvements. <strong>In the next article I'll talk about how Arachne/Security can help you with authorization.</strong> Later you can also expect an article about annotations-based security using <a href="https://github.com/Arachne/Verifier">Arachne/Verifier</a>.</p>
                </div>
            </div>

            <br>

            <div class="intermezzo-smaller">
                <div class="container">

Deprecated: "{$post|similarPosts} Latte filter was deprecated and will be removed in Statie 3.0. Use {$post|relatedPosts} instead." in /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/packages/RelatedPosts/src/Latte/Filter/RelatedPostsFilter.php on line 38

Call Stack:
    0.0001     362888   1. {main}() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie:0
    0.0003     371288   2. include_once('/home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie.php') /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie:4
    0.3133    7501304   3. Symfony\Component\Console\Application->run() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie.php:43
    0.3220    7677016   4. Symfony\Component\Console\Application->doRun() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Application.php:125
    0.3223    7677016   5. Symfony\Component\Console\Application->doRunCommand() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Application.php:224
    0.3223    7677016   6. Symplify\Statie\Console\Command\GenerateCommand->run() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Application.php:888
    0.3234    7681744   7. Symplify\Statie\Console\Command\GenerateCommand->execute() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Command/Command.php:262
    0.3235    7681744   8. Symplify\Statie\Application\StatieApplication->run() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Console/Command/GenerateCommand.php:43
    0.3710    9101952   9. Symplify\Statie\Application\StatieApplication->processTemplates() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Application/StatieApplication.php:63
    0.3714    9112680  10. Symplify\Statie\Renderable\RenderableFilesProcessor->processFiles() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Application/StatieApplication.php:105
    0.8253    9983752  11. Symplify\Statie\Renderable\Latte\LatteFileDecorator->decorateFiles() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/RenderableFilesProcessor.php:64
   22.5174   11846096  12. Symplify\Statie\Renderable\Latte\LatteFileDecorator->decorateFile() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/Latte/LatteFileDecorator.php:48
   22.5175   11847528  13. Symplify\Statie\Renderable\Latte\LatteFileDecorator->renderToString() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/Latte/LatteFileDecorator.php:79
   22.5175   11847624  14. Symplify\Statie\FlatWhite\Latte\LatteRenderer->renderExcludingHighlightBlocks() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/Latte/LatteFileDecorator.php:127
   22.5177   11858400  15. Latte\Engine->renderToString() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/packages/FlatWhite/src/Latte/LatteRenderer.php:68
   22.5362   11873960  16. Templatea11bd0eabb->capture() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Engine.php:81
   22.5362   11891280  17. Templatea11bd0eabb->render() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:326
   22.5364   11897720  18. Templatefbb92eba61->render() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:176
   22.5364   11898200  19. Templatefbb92eba61->main() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:198
   22.5371   11909448  20. Templatefbb92eba61->renderBlock() /tmp/_flat_white_latte_factory_cache/fbb92eba61.php:89
   22.5372   11909448  21. Templatefbb92eba61->blockRelatedPosts() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:282
   22.5372   11909472  22. Symplify\Statie\RelatedPosts\Latte\Filter\RelatedPostsFilter->Symplify\Statie\RelatedPosts\Latte\Filter\{closure}() /tmp/_flat_white_latte_factory_cache/fbb92eba61.php:169
   22.5372   11909472  23. trigger_error() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/packages/RelatedPosts/src/Latte/Filter/RelatedPostsFilter.php:38


        <h2>You Might Also Like</h2>

        <ul id="related-posts">
                <li>
                    <a href="/blog/2017/09/11/arachne-verifier-plus-arachne-entity-loader-using-entities-in-verifier-rules">Arachne/Verifier + Arachne/EntityLoader - Using Entities in Verifier Rules &raquo;</a>
                </li>
                <li>
                    <a href="/blog/2017/09/04/arachne-entity-loader-object-parameters-for-nette-application">Arachne/EntityLoader - Object Parameters for Nette/Application &raquo;</a>
                </li>
                <li>
                    <a href="/blog/2017/08/28/arachne-verifier-request-validator-for-nette-application">Arachne/Verifier - Request Validator for Nette/Application &raquo;</a>
                </li>
                <li>
                    <a href="/blog/2017/08/21/arachne-security-simplified-authorizator-and-fixed-acl-callbacks">Arachne/Security - Simplified Authorizator and Fixed ACL Callbacks &raquo;</a>
                </li>
        </ul>
                </div>
            </div>

            <div class="container">
<div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//' + "pehapkari" + '.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <br>
        </div>

        <script src="/assets/prism/prism.js"></script>
        <script id="dsq-count-scr" src="https://pehapkari.disqus.com/count.js" async defer></script>

<script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', "UA-89860072-1", 'auto');
    ga('send','pageview');
</script>
<script async defer src="https://www.google-analytics.com/analytics.js"></script>
<script>
    !function(f,b,e,v,n,t,s){ if(f.fbq)return;n=f.fbq=function(){ n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
            document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', "201338863559186");
    fbq('track', 'PageView');
</script>
    </body>
</html>


    <meta property="og:type" content="article">
    <meta property="og:title" content="Arachne/Security - Separate Authentication and Session Refresh">
    <meta property="og:description" content="In many cases Nette/Security lacks the API needed for certain tasks.
Experienced Nette users therefore often recommend using some custom solution instead.
In this article I&#039;ll go over the known problems with user authentication and how Arachne/Security can help you solve them.">
    <meta property="og:url" content="https://pehapkari.cz/blog/2017/08/14/arachne-security-separate-authentication-and-session-refresh/">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Arachne/Security - Separate Authentication and Session Refresh">
    <meta name="twitter:description" content="In many cases Nette/Security lacks the API needed for certain tasks.
Experienced Nette users therefore often recommend using some custom solution instead.
In this article I&#039;ll go over the known problems with user authentication and how Arachne/Security can help you solve them.">


    <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css">


