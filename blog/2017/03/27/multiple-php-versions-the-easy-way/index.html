<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="description" content="Oficiální stránky PHP komunity">
    <meta name="keywords" content="PHP, komunita, programování">
    <meta name="author" content="https://pehapkari.cz">
    <meta name="robots" content="index, follow">

    <meta property="og:image" content="/images/php-square.png">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

    <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <link href="/assets/bootstrap/bootstrap.min.css?v=0.6" rel="stylesheet" type="text/css">

    <link href="/assets/css/style.css?v=0.6" rel="stylesheet" type="text/css">

    <link href="/favicon.ico" rel="shortcut icon">

    <title>Multiple PHP versions, the easy way</title>
</head>

    <body>
<header>
    <div class="hidden-sm-down">
        <div class="container-fluid">
            <a href="/"><img src="/assets/images/logo-header.svg?ver" alt="" height="50"></a>

            <nav class="navbar top-navigation">
                <a href="/blog/" class="active">
                    <em class="fa fa-newspaper-o fa-fw"></em>
                    Blog
                </a>
                <a href="/vzdelavej-se/">
                    <em class="fa fa-graduation-cap fa-fw"></em>
                    Školení
                </a>
                <a href="/mentori/">
                    <em class="fa fa-handshake-o fa-fw"></em>
                    Mentoři
                </a>

                    

                    <a href="https://github.com/pehapkari/pehapkari.cz/edit/master/source/_posts/2017/2017-03-27-multiple-php-versions-the-easy-way.md" class="hidden-sm">
                        <em class="fa fa-fw fa-pencil"></em>
                        Edit
                    </a>
            </nav>
        </div>
    </div>

    <div id="mobile-menu" class="row text-center hidden-md-up">
        <div class="container">
            <a href="/" class="col-3 col-sm-3">
                <em class="fa fa-home"></em>
                <br>
                Home
            </a>
            <a href="/blog/" class="col-3 col-sm-3 active">
                <em class="fa fa-book fa-fw"></em>
                <br>
                Blog
            </a>
            <a href="/vzdelavej-se/" class="col-3 col-sm-3">
                <em class="fa fa-graduation-cap fa-fw"></em>
                <br>
                Školení
            </a>
            <a href="/mentori/" class="col-3 col-sm-3">
                <em class="fa fa-handshake-o fa-fw"></em>
                <br>
                Mentoři
            </a>
        </div>
    </div>
</header>

        <div id="article">
            <div class="container">
                <h1 class="h2 text-center">Multiple PHP versions, the easy way</h1>

                <div class="row text-center">
                    <div class="col-md-12">
<div class="metadataLine">

    <p>
        <em class="fa fa-clock-o fa-fw"></em>
        5 min

        |

        by <strong>Michael Moravec</strong>

        &ndash;

        <time datetime="2017-03-Mon">
            27. 3. 2017
        </time>

    </p>
</div>
                        <div id="reviewed_by">
                            <p>Peer-Reviewed by:
                                    Tomáš Jacík
                            </p>
                        </div>
                    </div>
                </div>

                <br>

                <div id="article-content">
                    <p class="perex">Always wanted to try or run your application with a different PHP version without breaking everything else? Why not, there is a way to run multiple versions in parallel!</p>

                    
<h2 id="basics"><a class="anchor" href="#basics" aria-hidden="true"><span class="anchor-icon">#</span></a>Basics</h2>
<p>There's a lot of use cases when one would need multiple PHP versions side by side.
As an example, assume we have one legacy application and one modern application.
The legacy one runs only on PHP 5.x whereas the modern one runs only on PHP 7.x.
Virtually impossible and disjunctive setup you'd say, right?
Before you start thinking about setting up second server with new PHP, consider the option of having two PHP versions side by side and letting your application <em>choose</em> one.</p>
<h2 id="what-do-we-need"><a class="anchor" href="#what-do-we-need" aria-hidden="true"><span class="anchor-icon">#</span></a>What do we need</h2>
<h4 id="debian-stretch"><a class="anchor" href="#debian-stretch" aria-hidden="true"><span class="anchor-icon">#</span></a>Debian Stretch</h4>
<p>We'll use Debian Stretch for this purpose.
Yes, at the time of writing, it's still an unreleased version, already in freeze though.
But it's going to have native support for co-installable PHP versions, so we'll use it for convenience.
You'll see later that it'd be eventually also possible to achieve this even with currently stable Jessie, although not with the native PHP package it distributes (<code>php5</code>).
Or you can use Ubuntu as well, it's based on Debian after all. :-)</p>
<h4 id="nginx"><a class="anchor" href="#nginx" aria-hidden="true"><span class="anchor-icon">#</span></a>NGINX</h4>
<p>Of course, we can suffer with the old friend Apache, but why would we?
NGINX performs much better and is way easier to configure with PHP FPM.
Also considering other features, i.e. HTTP/2, multi-certificate setup etc., there's really no show-stopper.</p>
<h4 id="php-with-co-installability-support"><a class="anchor" href="#php-with-co-installability-support" aria-hidden="true"><span class="anchor-icon">#</span></a>PHP with co-installability support</h4>
<p>This is probably the trickier part.
Luckily for us, starting with Debian Stretch there will be a new infrastructure for PHP packages that handles versioning natively.
No need to mess with the source code or modifying Debian packages themselves!</p>
<h2 id="putting-it-all-together"><a class="anchor" href="#putting-it-all-together" aria-hidden="true"><span class="anchor-icon">#</span></a>Putting it all together</h2>
<h4 id="install-nginx"><a class="anchor" href="#install-nginx" aria-hidden="true"><span class="anchor-icon">#</span></a>Install NGINX</h4>
<p>Installing NGINX is as simple as running this command:</p>
<pre><code>$ apt-get install nginx</code></pre>
<p>This will install NGINX with default modules and configuration.</p>
<h4 id="installing-php-7-0"><a class="anchor" href="#installing-php-7-0" aria-hidden="true"><span class="anchor-icon">#</span></a>Installing PHP 7.0</h4>
<p>Install PHP 7.0 from Debian archive.
This will be (sadly) the default version in Stretch, 7.1 came out too late to squeeze into Stretch's timeline.
Do this using the following command:</p>
<pre><code>$ apt-get install php7.0-cli php7.0-fpm</code></pre>
<p>Notice the different pattern of the package name.
Older Debian installations used simply <code>php5</code> whereas newer infrastructure uses <code>phpX.Y</code>.
This is the obvious part that efficiently allows us to use multiple PHPs in parallel.
With this structure, you can install each of the minor versions next to each other.</p>
<h4 id="installing-php-5-6"><a class="anchor" href="#installing-php-5-6" aria-hidden="true"><span class="anchor-icon">#</span></a>Installing PHP 5.6</h4>
<p>Here's the catch.
Debian only offers a single PHP version in the official repository.
Fortunately there are packages directly from a maintainer of Debian's PHP packages, Ondřej Surý.
Visit <a href="https://deb.sury.org/">his page</a> about packaging to learn more.
(There is also a PPA repository in case you'd rather use Ubuntu instead of Debian.)</p>
<p>We'll now add his repository (as well as enable HTTPS for APT and register the APT key):</p>
<pre><code>$ apt-get install apt-transport-https
$ curl https://packages.sury.org/php/apt.gpg | apt-key add -
$ echo 'deb https://packages.sury.org/php/ stretch main' &gt; /etc/apt/sources.list.d/deb.sury.org.list
$ apt-get update</code></pre>
<p>Now that we have the repository added, we can install the packages from there:</p>
<pre><code>$ apt-get install php5.6-cli php5.6-fpm</code></pre>
<p>This will install PHP 5.6 in parallel to PHP 7.0 installed earlier.
We can check this is true by simply running:</p>
<pre><code>$ php7.0 -v
PHP 7.0.15-1 (cli)
$ php5.6 -v
PHP 5.6.30-5+0~20170223133422.27+stretch~1.gbp1ee0cb (cli)</code></pre>
<p>Note that for conviniency there is also a <code>php</code> command provided by <em>alternatives</em> (which defaults to the newest version):</p>
<pre><code>$ php -v
PHP 7.0.15-1 (cli)</code></pre>
<p>You can switch the default version using update-alternatives, just run the following command and pick the version you prefer:</p>
<pre><code>$ update-alternatives --config php</code></pre>
<h4 id="configuring-php"><a class="anchor" href="#configuring-php" aria-hidden="true"><span class="anchor-icon">#</span></a>Configuring PHP</h4>
<p>Configuration is stored in versioned locations as well.
Additionally the configuration is separate for each SAPI.
Same applies to PHP modules so you don't have to worry about incompatible modules between versions.</p>
<p>We are looking for FPM configuration.
PHP 7.0 FPM configuration is stored in <code>/etc/php/7.0/fpm</code> and PHP 5.6 in <code>/etc/php/5.6/fpm</code>.
Each FPM instance consists of multiple pools.
Ideally each site/project should have its separate pool, but that's out of scope of this article, so we'll just use the default pool called <em>www</em>.
Open <code>/etc/php/7.0/fpm/pool.d/www.conf</code> and look for the <code>listen</code> option.
It should equal <code>/run/php/php7.0-fpm.sock</code> or similar.
Now do the same for 5.6, it should contain the same with just 5.6 instead of 7.0.
Note that it could also be a bind address, i.e. IP address with port (which is performance-wise more suitable for production than sockets).</p>
<h4 id="configuring-nginx"><a class="anchor" href="#configuring-nginx" aria-hidden="true"><span class="anchor-icon">#</span></a>Configuring NGINX</h4>
<p>NGINX configuration is stored inside <code>/etc/nginx</code>.
There are multiple files and directories, here's what we will need to know:</p>
<ul>
<li>By convention, all available virtual hosts are stored inside <em>sites-available</em> directory.</li>
<li>All production sites are then just symbolic links from <em>sites-enabled</em> to those files.</li>
<li>Any code intended for reuse across multiple virtual hosts is stored inside <em>snippets</em> folder.</li>
<li>The <code>fastcgi.conf</code> file contains all FastCGI-specific variables that are passed to PHP.</li>
<li>The <code>snippets/fastcgi-php.conf</code> is just a helper file to do all necessary before passing the request to PHP.</li>
</ul>
<p>Finally remove anything in <code>/etc/nginx/sites-enabled</code>, we don't want any default configuration to clutter with our setup.</p>
<h2 id="example-setup"><a class="anchor" href="#example-setup" aria-hidden="true"><span class="anchor-icon">#</span></a>Example setup</h2>
<p>Now that we have everything ready, let's create two virtual hosts.
For simplicity we'll just run them on a different port so we don't have to worry with setting up the hostnames.</p>
<h4 id="site-with-php-7-0"><a class="anchor" href="#site-with-php-7-0" aria-hidden="true"><span class="anchor-icon">#</span></a>Site with PHP 7.0</h4>
<p>First, create folder for our new site and just add a <code>phpinfo()</code> there:</p>
<pre><code>$ mkdir /var/www/site-with-php7.0
$ echo -e '&lt;?php\nphpinfo();' &gt; /var/www/site-with-php7.0/index.php</code></pre>
<p>Now create a simple virtual host with this content.
Put the following into <code>/etc/nginx/sites-available/site-with-php7.0</code>:</p>
<pre><code>server {
    listen 8870 default_server;
    listen [::]:8870 default_server;
    server_name _;
    root /var/www/site-with-php7.0;
    index index.php;
    location / {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php7.0-fpm.sock; # adjust for the listen setting discussed above
    }
}</code></pre>
<h4 id="site-with-php-5-6"><a class="anchor" href="#site-with-php-5-6" aria-hidden="true"><span class="anchor-icon">#</span></a>Site with PHP 5.6</h4>
<p>We'll do just the same for 5.6, except we'll change the port, root directory and FastCGI backend:</p>
<pre><code>mkdir /var/www/site-with-php5.6
echo -e '&lt;?php\nphpinfo();' &gt; /var/www/site-with-php5.6/index.php</code></pre>
<p>Put the following into <code>/etc/nginx/sites-available/site-with-php5.6</code>:</p>
<pre><code>server {
    listen 8856 default_server;
    listen [::]:8856 default_server;
    server_name _;
    root /var/www/site-with-php5.6;
    index index.php;
    location / {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php5.6-fpm.sock; # adjust for the listen setting discussed above
    }
}</code></pre>
<p>Enable these sites:</p>
<pre><code>$ ln -s ../sites-available/site-with-php5.6 /etc/nginx/sites-enabled
$ ln -s ../sites-available/site-with-php7.0 /etc/nginx/sites-enabled</code></pre>
<p>Reload NGINX and we're done:</p>
<pre><code>$ systemctl reload nginx.service</code></pre>
<h2 id="testing-everything-out"><a class="anchor" href="#testing-everything-out" aria-hidden="true"><span class="anchor-icon">#</span></a>Testing everything out</h2>
<p>We should now test that our setup works, shouldn't we?</p>
<h4 id="testing-site-with-7-0"><a class="anchor" href="#testing-site-with-7-0" aria-hidden="true"><span class="anchor-icon">#</span></a>Testing site with 7.0</h4>
<p>Head over to your browser and open <code>http://localhost:8870/</code>.
You should see the output of <code>phpinfo()</code> telling you that you are running PHP 7.0.</p>
<h4 id="testing-site-with-5-6"><a class="anchor" href="#testing-site-with-5-6" aria-hidden="true"><span class="anchor-icon">#</span></a>Testing site with 5.6</h4>
<p>Now do the same for 5.6 and open <code>http://localhost:8856/</code>.
You should be seeing PHP 5.6.</p>
<h2 id="conclusion"><a class="anchor" href="#conclusion" aria-hidden="true"><span class="anchor-icon">#</span></a>Conclusion</h2>
<p>The article should shed some of the myths about the needs and (im)possibility of running multiple PHP versions.
You now know how simple and straightforward such setup is and can deploy it right away.
It's of course also possible to install PHP 7.1 or 5.5, both are available in the aforementioned repository, configuration would be equivalent.
You can also use this setup on Ubuntu systems, everything is same except that you'll just do it the Ubuntu-way and use the mentioned PPA repository.</p>
<h3 id="complete-example-with-docker"><a class="anchor" href="#complete-example-with-docker" aria-hidden="true"><span class="anchor-icon">#</span></a>Complete example with Docker</h3>
<p>You can also find this example in the following <a href="https://gist.github.com/Majkl578/08bb58780344603ad253a9e3b0552eb0">GitHub Gist</a>.
If you would like to try it yourself, simply clone the Gist, build the image and run it locally:</p>
<pre><code>$ git clone https://gist.github.com/08bb58780344603ad253a9e3b0552eb0.git /tmp/multiphp
$ docker build -t multiphp /tmp/multiphp
$ docker run --rm -P multiphp</code></pre>
<p>Now just visit <a href="http://localhost:8870/">http://localhost:8870/</a> and <a href="http://localhost:8856/">http://localhost:8856/</a> respectively to see the result!</p>
                </div>
            </div>

            <br>

            <div class="intermezzo-smaller">
                <div class="container">

Deprecated: "{$post|similarPosts} Latte filter was deprecated and will be removed in Statie 3.0. Use {$post|relatedPosts} instead." in /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/packages/RelatedPosts/src/Latte/Filter/RelatedPostsFilter.php on line 38

Call Stack:
    0.0001     362888   1. {main}() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie:0
    0.0003     371288   2. include_once('/home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie.php') /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie:4
    0.3133    7501304   3. Symfony\Component\Console\Application->run() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie.php:43
    0.3220    7677016   4. Symfony\Component\Console\Application->doRun() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Application.php:125
    0.3223    7677016   5. Symfony\Component\Console\Application->doRunCommand() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Application.php:224
    0.3223    7677016   6. Symplify\Statie\Console\Command\GenerateCommand->run() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Application.php:888
    0.3234    7681744   7. Symplify\Statie\Console\Command\GenerateCommand->execute() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Command/Command.php:262
    0.3235    7681744   8. Symplify\Statie\Application\StatieApplication->run() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Console/Command/GenerateCommand.php:43
    0.3710    9101952   9. Symplify\Statie\Application\StatieApplication->processTemplates() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Application/StatieApplication.php:63
    0.3714    9112680  10. Symplify\Statie\Renderable\RenderableFilesProcessor->processFiles() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Application/StatieApplication.php:105
    0.8253    9983752  11. Symplify\Statie\Renderable\Latte\LatteFileDecorator->decorateFiles() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/RenderableFilesProcessor.php:64
   40.7726   12295592  12. Symplify\Statie\Renderable\Latte\LatteFileDecorator->decorateFile() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/Latte/LatteFileDecorator.php:48
   40.7726   12288816  13. Symplify\Statie\Renderable\Latte\LatteFileDecorator->renderToString() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/Latte/LatteFileDecorator.php:79
   40.7726   12288896  14. Symplify\Statie\FlatWhite\Latte\LatteRenderer->renderExcludingHighlightBlocks() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/Latte/LatteFileDecorator.php:127
   40.7729   12325408  15. Latte\Engine->renderToString() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/packages/FlatWhite/src/Latte/LatteRenderer.php:68
   40.8377   12456856  16. Templatebe19342d5e->capture() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Engine.php:81
   40.8377   12474176  17. Templatebe19342d5e->render() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:326
   40.8378   12480616  18. Templatefbb92eba61->render() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:176
   40.8379   12481096  19. Templatefbb92eba61->main() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:198
   40.8386   12492344  20. Templatefbb92eba61->renderBlock() /tmp/_flat_white_latte_factory_cache/fbb92eba61.php:89
   40.8386   12492344  21. Templatefbb92eba61->blockRelatedPosts() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:282
   40.8386   12492368  22. Symplify\Statie\RelatedPosts\Latte\Filter\RelatedPostsFilter->Symplify\Statie\RelatedPosts\Latte\Filter\{closure}() /tmp/_flat_white_latte_factory_cache/fbb92eba61.php:169
   40.8386   12492368  23. trigger_error() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/packages/RelatedPosts/src/Latte/Filter/RelatedPostsFilter.php:38


                </div>
            </div>

            <div class="container">
<div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//' + "pehapkari" + '.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <br>
        </div>

        <script src="/assets/prism/prism.js"></script>
        <script id="dsq-count-scr" src="https://pehapkari.disqus.com/count.js" async defer></script>

<script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', "UA-89860072-1", 'auto');
    ga('send','pageview');
</script>
<script async defer src="https://www.google-analytics.com/analytics.js"></script>
<script>
    !function(f,b,e,v,n,t,s){ if(f.fbq)return;n=f.fbq=function(){ n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
            document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', "201338863559186");
    fbq('track', 'PageView');
</script>
    </body>
</html>


    <meta property="og:type" content="article">
    <meta property="og:title" content="Multiple PHP versions, the easy way">
    <meta property="og:description" content="Always wanted to try or run your application with a different PHP version without breaking everything else? Why not, there is a way to run multiple versions in parallel!">
    <meta property="og:url" content="https://pehapkari.cz/blog/2017/03/27/multiple-php-versions-the-easy-way/">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Multiple PHP versions, the easy way">
    <meta name="twitter:description" content="Always wanted to try or run your application with a different PHP version without breaking everything else? Why not, there is a way to run multiple versions in parallel!">


    <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css">


