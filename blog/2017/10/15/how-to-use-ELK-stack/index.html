<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="description" content="Oficiální stránky PHP komunity">
    <meta name="keywords" content="PHP, komunita, programování">
    <meta name="author" content="https://pehapkari.cz">
    <meta name="robots" content="index, follow">

    <meta property="og:image" content="/images/php-square.png">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

    <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <link href="/assets/bootstrap/bootstrap.min.css?v=0.6" rel="stylesheet" type="text/css">

    <link href="/assets/css/style.css?v=0.6" rel="stylesheet" type="text/css">

    <link href="/favicon.ico" rel="shortcut icon">

    <title>How to use ELK stack</title>
</head>

    <body>
<header>
    <div class="hidden-sm-down">
        <div class="container-fluid">
            <a href="/"><img src="/assets/images/logo-header.svg?ver" alt="" height="50"></a>

            <nav class="navbar top-navigation">
                <a href="/blog/" class="active">
                    <em class="fa fa-newspaper-o fa-fw"></em>
                    Blog
                </a>
                <a href="/vzdelavej-se/">
                    <em class="fa fa-graduation-cap fa-fw"></em>
                    Školení
                </a>
                <a href="/mentori/">
                    <em class="fa fa-handshake-o fa-fw"></em>
                    Mentoři
                </a>

                    

                    <a href="https://github.com/pehapkari/pehapkari.cz/edit/master/source/_posts/2017/2017-10-15-how-to-use-ELK-stack.md" class="hidden-sm">
                        <em class="fa fa-fw fa-pencil"></em>
                        Edit
                    </a>
            </nav>
        </div>
    </div>

    <div id="mobile-menu" class="row text-center hidden-md-up">
        <div class="container">
            <a href="/" class="col-3 col-sm-3">
                <em class="fa fa-home"></em>
                <br>
                Home
            </a>
            <a href="/blog/" class="col-3 col-sm-3 active">
                <em class="fa fa-book fa-fw"></em>
                <br>
                Blog
            </a>
            <a href="/vzdelavej-se/" class="col-3 col-sm-3">
                <em class="fa fa-graduation-cap fa-fw"></em>
                <br>
                Školení
            </a>
            <a href="/mentori/" class="col-3 col-sm-3">
                <em class="fa fa-handshake-o fa-fw"></em>
                <br>
                Mentoři
            </a>
        </div>
    </div>
</header>

        <div id="article">
            <div class="container">
                <h1 class="h2 text-center">How to use ELK stack</h1>

                <div class="row text-center">
                    <div class="col-md-12">
<div class="metadataLine">

    <p>
        <em class="fa fa-clock-o fa-fw"></em>
        3 min

        |

        by <strong>Matěj Račinský</strong>

        &ndash;

        <time datetime="2017-10-Sun">
            15. 10. 2017
        </time>

    </p>
</div>
                    </div>
                </div>

                <br>

                <div id="article-content">
                    <p class="perex">In this article, I'll show you how to use ELK stack for logging. We will use ELK in docker for easy setup.</p>

                    
<h2 id="what-is-elk-stack"><a class="anchor" href="#what-is-elk-stack" aria-hidden="true"><span class="anchor-icon">#</span></a>What is ELK Stack</h2>
<p>ELK stack (now known as Elastic stack) stands for <a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a>,
<a href="https://www.elastic.co/products/logstash">Logstash</a>, <a href="https://www.elastic.co/products/kibana">Kibana</a> stack.
These three technologies are used for powerful log management.</p>
<p>Logstash is used to manage logs. It collects, parses and stores them.
There is a lot of existing inputs, filters and outputs.</p>
<p>Elasticsearch is powerful, distributed NoSQL database with REST API.
In ELK stack, Elasticsearch is used as persistent storage for our logs.</p>
<p>And Kibana visualizes logs from Elasticsearch and lets you create many handy visualizations and dashboards
which allow you to see all important metrics in one place.</p>
<h2 id="how-to-run-elk-stack-theory"><a class="anchor" href="#how-to-run-elk-stack-theory" aria-hidden="true"><span class="anchor-icon">#</span></a>How to run ELK Stack: Theory</h2>
<p>The most simple installation of ELK is with docker. Because there are 3 services in ELK (obviously),
you need to use <code>docker-compose</code> to manage them with ease.</p>
<p>There are many <code>docker-compose</code> projects for ELK on github, I use <a href="https://github.com/deviantony/docker-elk/tree/searchguard">this repository</a>.
Note that this links to searchguard branch of the git repository.</p>
<p>Readme of the github repository describes how to run the ELK stack, be sure to check it out for further use.</p>
<h3 id="security-note-use-searchguard"><a class="anchor" href="#security-note-use-searchguard" aria-hidden="true"><span class="anchor-icon">#</span></a>Security Note: Use Searchguard</h3>
<p>ELK stack does not offer authentication out of the box.</p>
<p>Searchguard is plugin to Elasticsearch, which adds authentication.
You should not use ELK without any kind of authentication!</p>
<p>Note that you need to initialize the searchguard after starting services with <code>docker-compose up</code>,
as <a href="https://github.com/deviantony/docker-elk/tree/searchguard#bringing-up-the-stack">described here</a>.
Without it, searchguard will not work.</p>
<p>There is no need to configure elasticsearch for this example, since it can infer schema from data sent to it,
so we will configure only Logstash in this article (except of searchguard configuration).</p>
<p>Logstash has inputs and outputs configuration in <a href="https://github.com/deviantony/docker-elk/blob/searchguard/logstash/pipeline/logstash.conf">logstash.conf</a>.
Note that directory with <code>logstash.conf</code> is mounted as volume in <a href="https://github.com/deviantony/docker-elk/blob/searchguard/docker-compose.yml">docker-compose.yml</a>,
so there is no need to rebuild the image when <code>logstash.conf</code> is changed.</p>
<p>Also, by default mapping of data in Elasticsearch to host OS is not present.  </p>
<p>So we will have to modify <code>volumes</code> section in the <code>docker-compose.yml</code>, so it maps data from Elasticsearch.</p>
<p>That was some theory and now let's try it in practise.</p>
<h2 id="how-to-run-elk-stack-practise"><a class="anchor" href="#how-to-run-elk-stack-practise" aria-hidden="true"><span class="anchor-icon">#</span></a>How to run ELK Stack: Practise</h2>
<ol>
<li><a href="https://github.com/deviantony/docker-elk.git">clone the repo</a></li>
<li>switch to searchguard branch by <code>git checkout searchguard</code></li>
<li>
<p>Update the <code>docker-compose.yml</code> file to persist Elasticsearch data:</p>
<p>Add <code>- ./elasticsearch/data:/usr/share/elasticsearch/data</code> to the <code>volumes</code> section of <code>elasticsearch</code> service.</p>
<p>So the <code>volumes</code> section should like this:  </p>
<pre><code class="language-yml">volumes:
    - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
    - ./elasticsearch/data:/usr/share/elasticsearch/data</code></pre>
</li>
<li>run the stack by <code>docker-compose up</code></li>
<li>initialize the searchguard by <code>docker-compose exec -T elasticsearch bin/init_sg.sh</code></li>
</ol>
<p>Now <a href="http://localhost:9200/">Elasticsearch runs on port 9200</a> and <a href="http://localhost:5601/">Kibana runs on port 5601</a>.</p>
<p>As you could notice, on both sites you are asked for login.
That's because the searchguard branch contains Elasticsearch with Searchguard plugin installed.</p>
<p>To try it out, you can use username <code>admin</code> and password <code>admin</code>. </p>
<p>So now we have ELK stack fully working!</p>
<p>Of course you don't want to use your ELK stack with these users without changing password,
because using publicly accessible passwords does not offer much security.</p>
<h3 id="searchguard-configuration-changing-passwords"><a class="anchor" href="#searchguard-configuration-changing-passwords" aria-hidden="true"><span class="anchor-icon">#</span></a>Searchguard Configuration - Changing Passwords</h3>
<p>When you run the ELK stack with searchguard, it already contains some predefined users with configured privileges.
You can see these users <a href="https://github.com/floragunncom/search-guard-docs/blob/master/configuration_internalusers.md">in searchguard documentation</a>.</p>
<p>Searchguard users are stored in file <a href="https://github.com/deviantony/docker-elk/blob/searchguard/elasticsearch/config/sg_internal_users.yml">elasticsearch/config/sg_internal_users.yml</a>.</p>
<p>Contents of this file is</p>
<pre><code class="language-yaml">admin:
  hash: $2a$12$VcCDgh2NDk07JGN0rjGbM.Ad41qVR/YFJcgHp0UGns5JDymv..TOG
  #password is: admin
logstash:
  hash: $2a$12$u1ShR4l4uBS3Uv59Pa2y5.1uQuZBrZtmNfqB3iM/.jL0XoV9sghS2
  #password is: logstash
kibanaserver:
  hash: $2a$12$4AcgAt3xwOWadA5s5blL6ev39OXDNhmOesEoo33eZtrq2N0YrU3H.
  #password is: kibanaserver
kibanaro:
  hash: $2a$12$JJSXNfTowz7Uu5ttXfeYpeYE0arACvcwlPBStB1F.MI7f0U9Z4DGC
  #password is: kibanaro</code></pre>
<p>Now, we'll change these passwords. As we can see, passwords are not stored in plaintext in this yml file, but bcrypt hash is used instead.
We can generate has for new password by running hashing script in our docker container.</p>
<p>Hashing script is in the elasticsearch service, because the searchguard is installed there. </p>
<p>By default, <code>elasticsearch/config/sg_internal_users.yml</code> is not mapped as volume, but used only during build of the Elasticsearch image.
We will define this file as volume in <code>docker-compose.yml</code> to easily change password without need to rebuild the image.</p>
<p>So to change passwords:</p>
<ol>
<li>
<p>Add <code>./elasticsearch/config/sg_internal_users.yml:/usr/share/elasticsearch/config/sg_internal_users.yml</code> to the <code>volumes</code> section of the <code>elasticsearch</code> service.</p>
<p>Now our <code>volumes</code> section looks like this:</p>
<pre><code class="language-yml">volumes:
    - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
    - ./elasticsearch/data:/usr/share/elasticsearch/data
    - ./elasticsearch/config/sg_internal_users.yml:/usr/share/elasticsearch/config/sg_internal_users.yml</code></pre>
</li>
<li>
<p>Generate hash of new password by </p>
<pre><code class="language-bash">docker-compose run elasticsearch plugins/search-guard-5/tools/hash.sh -p [some_password]</code></pre>
</li>
<li>Replace default hashes with the new ones in the file <code>sg_internal_users.yml</code></li>
<li>Restart the stack by
<pre><code class="language-bash">docker-compose down
docker-compose up</code></pre></li>
</ol>
<p>Congratulations, now you have your ELK stack running and secure.</p>
<p>Log in using the admin account from searchguard, because kibana uses these credentials to access Elasticsearch.
Otherwise you could have problems with accessing logs.</p>
<p>Now you have ELK stack running and secure.</p>
                </div>
            </div>

            <br>

            <div class="intermezzo-smaller">
                <div class="container">

Deprecated: "{$post|similarPosts} Latte filter was deprecated and will be removed in Statie 3.0. Use {$post|relatedPosts} instead." in /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/packages/RelatedPosts/src/Latte/Filter/RelatedPostsFilter.php on line 38

Call Stack:
    0.0001     362888   1. {main}() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie:0
    0.0003     371288   2. include_once('/home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie.php') /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie:4
    0.3133    7501304   3. Symfony\Component\Console\Application->run() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/bin/statie.php:43
    0.3220    7677016   4. Symfony\Component\Console\Application->doRun() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Application.php:125
    0.3223    7677016   5. Symfony\Component\Console\Application->doRunCommand() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Application.php:224
    0.3223    7677016   6. Symplify\Statie\Console\Command\GenerateCommand->run() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Application.php:888
    0.3234    7681744   7. Symplify\Statie\Console\Command\GenerateCommand->execute() /home/travis/build/pehapkari/pehapkari.cz/vendor/symfony/console/Command/Command.php:262
    0.3235    7681744   8. Symplify\Statie\Application\StatieApplication->run() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Console/Command/GenerateCommand.php:43
    0.3710    9101952   9. Symplify\Statie\Application\StatieApplication->processTemplates() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Application/StatieApplication.php:63
    0.3714    9112680  10. Symplify\Statie\Renderable\RenderableFilesProcessor->processFiles() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Application/StatieApplication.php:105
    0.8253    9983752  11. Symplify\Statie\Renderable\Latte\LatteFileDecorator->decorateFiles() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/RenderableFilesProcessor.php:64
    4.3207   11423000  12. Symplify\Statie\Renderable\Latte\LatteFileDecorator->decorateFile() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/Latte/LatteFileDecorator.php:48
    4.3207   11420296  13. Symplify\Statie\Renderable\Latte\LatteFileDecorator->renderToString() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/Latte/LatteFileDecorator.php:79
    4.3207   11420352  14. Symplify\Statie\FlatWhite\Latte\LatteRenderer->renderExcludingHighlightBlocks() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/src/Renderable/Latte/LatteFileDecorator.php:127
    4.3209   11434224  15. Latte\Engine->renderToString() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/packages/FlatWhite/src/Latte/LatteRenderer.php:68
    4.3599   11608992  16. Template5dd99cce93->capture() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Engine.php:81
    4.3599   11626312  17. Template5dd99cce93->render() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:326
    4.3601   11632752  18. Templatefbb92eba61->render() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:176
    4.3601   11633232  19. Templatefbb92eba61->main() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:198
    4.3607   11644080  20. Templatefbb92eba61->renderBlock() /tmp/_flat_white_latte_factory_cache/fbb92eba61.php:89
    4.3607   11644080  21. Templatefbb92eba61->blockRelatedPosts() /home/travis/build/pehapkari/pehapkari.cz/vendor/latte/latte/src/Latte/Runtime/Template.php:282
    4.3607   11644104  22. Symplify\Statie\RelatedPosts\Latte\Filter\RelatedPostsFilter->Symplify\Statie\RelatedPosts\Latte\Filter\{closure}() /tmp/_flat_white_latte_factory_cache/fbb92eba61.php:169
    4.3607   11644104  23. trigger_error() /home/travis/build/pehapkari/pehapkari.cz/vendor/symplify/statie/packages/RelatedPosts/src/Latte/Filter/RelatedPostsFilter.php:38


        <h2>You Might Also Like</h2>

        <ul id="related-posts">
                <li>
                    <a href="/blog/2017/10/22/connecting-monolog-with-ELK">How to connect ELK with Monolog &raquo;</a>
                </li>
                <li>
                    <a href="/blog/2017/03/02/php-u-nas-ceka-rok-expanze">PHP u nás čeká rok expanze &raquo;</a>
                </li>
        </ul>
                </div>
            </div>

            <div class="container">
<div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//' + "pehapkari" + '.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <br>
        </div>

        <script src="/assets/prism/prism.js"></script>
        <script id="dsq-count-scr" src="https://pehapkari.disqus.com/count.js" async defer></script>

<script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', "UA-89860072-1", 'auto');
    ga('send','pageview');
</script>
<script async defer src="https://www.google-analytics.com/analytics.js"></script>
<script>
    !function(f,b,e,v,n,t,s){ if(f.fbq)return;n=f.fbq=function(){ n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
            document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', "201338863559186");
    fbq('track', 'PageView');
</script>
    </body>
</html>


    <meta property="og:type" content="article">
    <meta property="og:title" content="How to use ELK stack">
    <meta property="og:description" content="In this article, I&#039;ll show you how to use ELK stack for logging. We will use ELK in docker for easy setup.">
    <meta property="og:url" content="https://pehapkari.cz/blog/2017/10/15/how-to-use-ELK-stack/">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="How to use ELK stack">
    <meta name="twitter:description" content="In this article, I&#039;ll show you how to use ELK stack for logging. We will use ELK in docker for easy setup.">


    <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css">


